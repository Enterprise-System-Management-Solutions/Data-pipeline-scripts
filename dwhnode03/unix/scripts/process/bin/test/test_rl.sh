#Author :       Tareq
#Date   :       16-05-2020
#!/bin/bash


PATH=$PATH:$HOME/.local/bin:$HOME/bin

export PATH

export TMP=/tmp
export TMPDIR=$TMP

export ORACLE_HOSTNAME=dwhnode03
export ORACLE_UNQNAME=dwhdb03
export ORACLE_BASE=/data01/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/19.0.0/dbhome_1
export ORA_INVENTORY=/data01/app/oraInventory
export ORACLE_SID=dwhdb03
export DATA_DIR=/data01/oradata

export PATH=/usr/sbin:/usr/local/bin:$PATH
export PATH=$ORACLE_HOME/bin:$PATH

export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib
export CLASSPATH=$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib


sqlplus  -s <<EOF
dwh_user03/dwh_user_123
SET echo on
SET head off
SET feedback off
WHENEVER SQLERROR EXIT SQL.SQLCODE
create table RECHARGE_LOCATION_FCT_ld as
SELECT MSISDN,M09_LOCATION,RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE24_RESULT_CODE,M07_ANSWERTIMESTAMP, RE30_ENTRY_DATE, RE489_MAINOFFERINGID, CHARGINGTIME
FROM
(SELECT MSISDN,M09_LOCATION,RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE24_RESULT_CODE,M07_ANSWERTIMESTAMP, RE30_ENTRY_DATE, RE489_MAINOFFERINGID, CHARGINGTIME
,RANK ()OVER(PARTITION BY MSISDN ORDER BY CHARGINGTIME ASC )FS
    FROM
(
select /*+ parallel (A,16)*/  MSISDN,M09_LOCATION,RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE24_RESULT_CODE,M07_ANSWERTIMESTAMP, RE30_ENTRY_DATE, RE489_MAINOFFERINGID,TO_NUMBER(TRIM(LEADING '-' FROM CHARGINGTIME)) as CHARGINGTIME
from
(SELECT /*+ parallel (A.16)*/  A.MSISDN,A.M09_LOCATION,RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE24_RESULT_CODE,M07_ANSWERTIMESTAMP, RE30_ENTRY_DATE, RE489_MAINOFFERINGID,A.M07_ANSWERTIMESTAMP-RE30_ENTRY_DATE AS CHARGINGTIME
            FROM
                (SELECT /*+ parallel (A,16)*/ M04_MSISDNAPARTY AS MSISDN,M09_LOCATION ,SUBSTR((M07_ANSWERTIMESTAMP),1,10) AS M07_ANSWERTIMESTAMP
                FROM L1_MSC A
                WHERE SUBSTR((M07_ANSWERTIMESTAMP),1,8)=(SELECT TO_CHAR(DATE_VALUE,'RRRRMMDD') AS DATE_VALUE FROM DATE_DIM WHERE TO_CHAR(DATE_VALUE,'RRRRMMDD')=TO_CHAR(SYSDATE-1,'RRRRMMDD'))
                )A,
                (SELECT /*+ parallel (A,16)*/  RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE6_PRI_IDENTITY as MSISDN, RE24_RESULT_CODE, SUBSTR(RE30_ENTRY_DATE,1,10) AS RE30_ENTRY_DATE, RE489_MAINOFFERINGID
                FROM L3_RECHARGE A
                WHERE SUBSTR((RE30_ENTRY_DATE),1,8)=(SELECT TO_CHAR(DATE_VALUE,'RRRRMMDD') AS DATE_VALUE FROM DATE_DIM WHERE TO_CHAR(DATE_VALUE,'RRRRMMDD')=TO_CHAR(SYSDATE-1,'RRRRMMDD'))
                )B
            WHERE A.MSISDN=B.MSISDN
            )A
        union all
select /*+ parallel (B,16)*/  MSISDN,M09_LOCATION,RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE24_RESULT_CODE,M07_ANSWERTIMESTAMP, RE30_ENTRY_DATE, RE489_MAINOFFERINGID,TO_NUMBER(TRIM(LEADING '-' FROM CHARGINGTIME)) as CHARGINGTIME
from
(SELECT /*+ parallel (A,16)*/  A.MSISDN,A.M09_LOCATION,RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE24_RESULT_CODE,M07_ANSWERTIMESTAMP, RE30_ENTRY_DATE, RE489_MAINOFFERINGID,RE30_ENTRY_DATE-A.M07_ANSWERTIMESTAMP AS CHARGINGTIME
            FROM
                (SELECT /*+ parallel (A,16)*/ M04_MSISDNAPARTY AS MSISDN,M09_LOCATION ,SUBSTR((M07_ANSWERTIMESTAMP),1,10) AS M07_ANSWERTIMESTAMP
                FROM L1_MSC A
                WHERE SUBSTR((M07_ANSWERTIMESTAMP),1,8)=(SELECT TO_CHAR(DATE_VALUE,'RRRRMMDD') AS DATE_VALUE FROM DATE_DIM WHERE TO_CHAR(DATE_VALUE,'RRRRMMDD')=TO_CHAR(SYSDATE-1,'RRRRMMDD'))
                )A,
                (SELECT /*+ parallel (A,16)*/  RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE6_PRI_IDENTITY as MSISDN, RE24_RESULT_CODE, SUBSTR(RE30_ENTRY_DATE,1,10) AS RE30_ENTRY_DATE, RE489_MAINOFFERINGID
                FROM L3_RECHARGE A
                WHERE SUBSTR((RE30_ENTRY_DATE),1,8)=(SELECT TO_CHAR(DATE_VALUE,'RRRRMMDD') AS DATE_VALUE FROM DATE_DIM WHERE TO_CHAR(DATE_VALUE,'RRRRMMDD')=TO_CHAR(SYSDATE-1,'RRRRMMDD'))
                )B
            WHERE A.MSISDN=B.MSISDN
            )B
            )
    GROUP BY MSISDN,M09_LOCATION,RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE24_RESULT_CODE,M07_ANSWERTIMESTAMP, RE30_ENTRY_DATE, RE489_MAINOFFERINGID, CHARGINGTIME
    )
WHERE FS=1
GROUP BY MSISDN,M09_LOCATION,RE3_RECHARGE_AMT, RE7_THIRD_PARTY_NUMBER, RE24_RESULT_CODE,M07_ANSWERTIMESTAMP, RE30_ENTRY_DATE, RE489_MAINOFFERINGID, CHARGINGTIME
/
commit
/
EXIT
EOF
