#Author :       Tareq
#Date   :       05-10-2020
#!/bin/bash


PATH=$PATH:$HOME/.local/bin:$HOME/bin

export PATH

export TMP=/tmp
export TMPDIR=$TMP

export ORACLE_HOSTNAME=dwhnode03
export ORACLE_UNQNAME=dwhdb03
export ORACLE_BASE=/data01/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/19.0.0/dbhome_1
export ORA_INVENTORY=/data01/app/oraInventory
export ORACLE_SID=dwhdb03
export DATA_DIR=/data01/oradata

export PATH=/usr/sbin:/usr/local/bin:$PATH
export PATH=$ORACLE_HOME/bin:$PATH

export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib
export CLASSPATH=$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib


partition=`
sqlplus  -s <<EOF
dwh_user03/dwh_user_123
SET echo on
SET head off
SET feedback off
WHENEVER SQLERROR EXIT SQL.SQLCODE
SELECT F_PARTITION_MSC FROM DUAL;
EXIT
EOF`

partition2=`
sqlplus  -s <<EOF
dwh_user03/dwh_user_123
SET echo on
SET head off
SET feedback off
WHENEVER SQLERROR EXIT SQL.SQLCODE
SELECT F_PARTITION_MSC_2 FROM DUAL;
EXIT
EOF`


mtc ()
{
sqlplus  -s <<EOF
dwh_user03/dwh_user_123
SET echo on
SET head off
SET feedback off
WHENEVER SQLERROR EXIT SQL.SQLCODE
TRUNCATE TABLE MTC_CALL_DURATION DROP STORAGE;
INSERT INTO MTC_CALL_DURATION
SELECT DATE_KEY,TIME_KEY,M04_MSISDNAPARTY,M09_LOCATION,sum(M08_CALLDUR) AS CALLDUR
FROM
    (
    SELECT (SELECT DATE_KEY FROM DATE_DIM WHERE TRUNC(DATE_VALUE) =TRUNC(SYSDATE-1)) DATE_KEY,SUBSTR(M07_ANSWERTIMESTAMP,9,4)TIME_KEY,M04_MSISDNAPARTY,M09_LOCATION,M08_CALLDUR
    FROM L1_MSC PARTITION($1)
    WHERE  SUBSTR(M07_ANSWERTIMESTAMP,1,8)= (SELECT TO_CHAR(DATE_VALUE,'rrrrmmdd') FROM DATE_DIM WHERE TRUNC(DATE_VALUE)=TRUNC(SYSDATE-1))
    AND SUBSTR(M04_MSISDNAPARTY,1,4)='8801'
    AND M01_CALLTYPE='MTC'
    UNION ALL
    SELECT (SELECT DATE_KEY FROM DATE_DIM WHERE TRUNC(DATE_VALUE) =TRUNC(SYSDATE-1)) DATE_KEY,SUBSTR(M07_ANSWERTIMESTAMP,9,4)TIME_KEY,M04_MSISDNAPARTY,M09_LOCATION,M08_CALLDUR
    FROM L1_MSC PARTITION($2)
    WHERE  SUBSTR(M07_ANSWERTIMESTAMP,1,8)= (SELECT TO_CHAR(DATE_VALUE,'rrrrmmdd') FROM DATE_DIM WHERE TRUNC(DATE_VALUE)=TRUNC(SYSDATE-1))
    AND SUBSTR(M04_MSISDNAPARTY,1,4)='8801'
    AND M01_CALLTYPE='MTC'
    )
GROUP BY DATE_KEY,TIME_KEY,M04_MSISDNAPARTY,M09_LOCATION
/
COMMIT
/
EXIT
EOF
}

smsmt ()
{
sqlplus  -s <<EOF
dwh_user03/dwh_user_123
SET echo on
SET head off
SET feedback off
WHENEVER SQLERROR EXIT SQL.SQLCODE
TRUNCATE TABLE MTSMS_COUNT DROP STORAGE;
INSERT INTO MTSMS_COUNT
SELECT DATE_KEY,TIME_KEY,M04_MSISDNAPARTY,M09_LOCATION,COUNT(M04_MSISDNAPARTY) AS COUNT
FROM
    (
    SELECT (SELECT DATE_KEY FROM DATE_DIM WHERE TRUNC(DATE_VALUE) =TRUNC(SYSDATE-1)) DATE_KEY,SUBSTR(M07_ANSWERTIMESTAMP,9,4)TIME_KEY,M04_MSISDNAPARTY,M09_LOCATION
    FROM L1_MSC PARTITION($1)
    WHERE  SUBSTR(M07_ANSWERTIMESTAMP,1,8)= (SELECT TO_CHAR(DATE_VALUE,'rrrrmmdd') FROM DATE_DIM WHERE TRUNC(DATE_VALUE)=TRUNC(SYSDATE-1))
    AND SUBSTR(M04_MSISDNAPARTY,1,4)='8801'
    AND M01_CALLTYPE='SMSMT'
    UNION ALL
    SELECT (SELECT DATE_KEY FROM DATE_DIM WHERE TRUNC(DATE_VALUE) =TRUNC(SYSDATE-1)) DATE_KEY,SUBSTR(M07_ANSWERTIMESTAMP,9,4)TIME_KEY,M04_MSISDNAPARTY,M09_LOCATION
    FROM L1_MSC PARTITION($2)
    WHERE  SUBSTR(M07_ANSWERTIMESTAMP,1,8)= (SELECT TO_CHAR(DATE_VALUE,'rrrrmmdd') FROM DATE_DIM WHERE TRUNC(DATE_VALUE)=TRUNC(SYSDATE-1))
    AND SUBSTR(M04_MSISDNAPARTY,1,4)='8801'
    AND M01_CALLTYPE='SMSMT'
    )
GROUP BY DATE_KEY,TIME_KEY,M04_MSISDNAPARTY,M09_LOCATION
/
COMMIT
/

EXIT
EOF
}


lock=/data02/scripts/process/bin/mtc_and_smsmt  export lock

if [ -f $lock ] ; then
exit 2

else
touch $lock


echo $partition $partition2
mtc $partition $partition2
smsmt $partition $partition2

rm -f $lock

fi


